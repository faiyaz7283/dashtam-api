name: "Release Phase 3: Tag, Release, and Sync"

# Trigger: When PR to main is merged
on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  finalize-release:
    # Only run if:
    # 1. PR was actually merged (not just closed)
    # 2. PR has the 'automated-release' label
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'automated-release')
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Extract version from PR title
        id: version
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR title: $PR_TITLE"
          
          # Extract version (e.g., "chore(release): v1.9.3" -> "1.9.3")
          if [[ "$PR_TITLE" =~ chore\(release\):\ v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Extracted version: $VERSION"
          else
            echo "âŒ Could not extract version from PR title: $PR_TITLE"
            exit 1
          fi
      
      - name: Verify version exists in CHANGELOG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          if ! grep -q "^## \[$VERSION\]" CHANGELOG.md; then
            echo "âŒ Version $VERSION not found in CHANGELOG.md"
            exit 1
          fi
          
          echo "âœ… Version $VERSION exists in CHANGELOG.md"
      
      - name: Extract CHANGELOG entry for release notes
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extract CHANGELOG section for this version
          CHANGELOG_ENTRY=$(awk '/^## \['"$VERSION"'\]/,/^## \[/{if(/^## \[/ && !/^## \['"$VERSION"'\]/) exit; print}' CHANGELOG.md)
          
          if [[ -z "$CHANGELOG_ENTRY" ]]; then
            echo "âŒ No CHANGELOG entry found for v$VERSION"
            exit 1
          fi
          
          # Save to file for GitHub Release
          echo "$CHANGELOG_ENTRY" > /tmp/release-notes.md
          echo "release_notes_file=/tmp/release-notes.md" >> $GITHUB_OUTPUT
          echo "âœ… Extracted CHANGELOG entry"
      
      - name: Create and push git tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"
          
          # Check if tag already exists
          if git tag -l | grep -q "^$TAG$"; then
            echo "âš ï¸  Tag $TAG already exists, skipping tag creation"
          else
            # Create annotated tag
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "âœ… Created and pushed tag: $TAG"
          fi
      
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"
          RELEASE_NOTES="${{ steps.changelog.outputs.release_notes_file }}"
          
          # Check if release already exists
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "âš ï¸  Release $TAG already exists, skipping release creation"
          else
            # Create GitHub Release
            gh release create "$TAG" \
              --repo "${{ github.repository }}" \
              --title "$TAG" \
              --notes-file "$RELEASE_NOTES"
            
            echo "âœ… Created GitHub Release: $TAG"
          fi
      
      - name: Sync main â†’ development
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SYNC_BRANCH="sync-main-v$VERSION"
          
          # Fetch latest
          git fetch origin main
          git fetch origin development
          
          # Checkout development
          git checkout development
          git pull origin development
          
          # Merge main into development (no fast-forward to preserve merge commit)
          git merge origin/main --no-edit --no-ff -m "chore: sync main â†’ development after v$VERSION release"
          
          # Push to temporary sync branch
          git push origin "HEAD:$SYNC_BRANCH"
          
          # Create PR from sync branch to development
          gh pr create \
            --repo "${{ github.repository }}" \
            --base development \
            --head "$SYNC_BRANCH" \
            --title "chore: sync main â†’ development after v$VERSION release" \
            --body "Post-release sync after v$VERSION was released to main.
          
          This PR is automatically created by Phase 3 workflow to sync changes from main back to development.
          
          **Changes**: Merge commit from main after release."
          
          # Enable auto-merge if available (will fail silently if not enabled)
          PR_URL=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$SYNC_BRANCH" \
            --base development \
            --limit 1 \
            --json url \
            --jq '.[0].url')
          
          PR_NUMBER=$(basename "$PR_URL")
          
          # Try to enable auto-merge (fails gracefully if not enabled on repo)
          gh pr merge "$PR_NUMBER" --repo "${{ github.repository }}" --auto --merge 2>/dev/null || echo "âš ï¸  Auto-merge not available, PR requires manual merge"
          
          echo "âœ… Created sync PR: $PR_URL"
      
      - name: Remove automated-release label from PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Remove label from the merged PR (main PR)
          gh pr edit "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --remove-label "automated-release" || true
          
          echo "âœ… Removed automated-release label from PR #$PR_NUMBER"
          
          # Find and remove label from the original development PR
          # Search for the most recent closed PR to development with the label
          DEV_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --base development \
            --state closed \
            --label "automated-release" \
            --limit 1 \
            --json number \
            --jq '.[0].number')
          
          if [[ -n "$DEV_PR" && "$DEV_PR" != "null" ]]; then
            gh pr edit "$DEV_PR" \
              --repo "${{ github.repository }}" \
              --remove-label "automated-release" || true
            echo "âœ… Removed automated-release label from development PR #$DEV_PR"
          fi
      
      - name: Post-release summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ‰ Release v$VERSION Complete!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Tagged: $TAG"
          echo "âœ… GitHub Release created"
          echo "âœ… Synced main â†’ development"
          echo "âœ… Cleaned up labels"
          echo "âœ… Deleted release branch"
          echo ""
          echo "View release: https://github.com/${{ github.repository }}/releases/tag/$TAG"
          echo ""
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Release finalization failed"
          echo "Manual intervention required"
          echo ""
          echo "Check the following:"
          echo "  1. Tag creation"
          echo "  2. GitHub Release creation"
          echo "  3. Branch sync (main â†’ development)"
          echo ""
          exit 1
